<!DOCTYPE html>
<html lang="en">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<head>
	<meta charset="utf-8">
	<title>Private Chat</title>
	<link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
	<link href="index.css" rel="stylesheet">
</head>
<body>
    <div id="wrap-showtexts"></div>
    <div id="msgbox" class="msgbox"></div>
    <div id="wrap-input">
		<textarea type="text" id="getText" placeholder="Enter your text"></textarea></br></br>
		<div class="flex-button">
			<button OnClick="getText(window.value)">Refresh</button>
			<button OnClick="submitText()">Send</button>
		</div>
	</div>
	<!-- <div class="copyright">
		&copy; Encrypted
	</div> -->
</body>
<script>
	var username = window.prompt("Please Enter Username")
	// var private_key = window.prompt("Please Enter Private Key")
	// var username = 'das'
	function submitText(){
		var text=document.getElementById('getText').value
		var senddata={"text":text, "date":Date().toString().slice(4, 24), "sender":username}
		axios.post(window.value.toString().slice(0,41),senddata).then(function(res){
			// document.getElementById('msgbox').innerHTML="Message Sent"
			document.getElementById('getText').value=""
			getText(window.value)
			// document.getElementById('msgbox').innerHTML=""
		})
	}
	window.onload=getEurl()
	function getEurl(){
		var key = window.prompt("Please Enter Private Key")
		// var key = '123'
		var url = `https://script.google.com/macros/s/AKfycbzxWw-sFLslbSCCOYxwculKb4JAZGd4sUjUXPZY2GvpJFKoFf4/exec?key=${key}`
		fetch(url).then(response => response.json())
		.then(data => {
			console.log(data['url'])
			window.value = data['url']
			getText(data['url'])
		});
	}
	function getText(eurl){
		var allTexts=[]
		// fetch(eurl).then(response => response.json())
		// .then(response => {
		// 	console.log('response', response)
		// 	allTexts = []
		// 	for(let key in response.data) {
		// 		response.data.id = key
		// 		allTexts.push(response.data[key])
		// 	}
			// console.log(allTexts)
		// })
		// console.log(allTexts)
		axios.get(eurl).then(function(res){
			allTexts=[]
			for(let key in res.data){
				res.data.id=key;
				allTexts.push(res.data[key])
			}
			// console.log('allTexts: ', allTexts)
			// allTexts.reverse()
		}).then(function(){
			for( let  i in allTexts){
				var elem=document.createElement('div')
					elem.setAttribute('id','box'+i)
					elem.setAttribute('class','box')
					elem.innerHTML=allTexts[i].text
					document.getElementById('wrap-showtexts').appendChild(elem)
				var elem2=document.createElement('div')
					elem2.setAttribute('class','date')
					elem2.innerHTML=allTexts[i].date + " " + allTexts[i].sender
					document.getElementById('wrap-showtexts').appendChild(elem2)					
			}
			window.scrollTo(0,document.body.scrollHeight)
		})
	}
</script>
</html>
